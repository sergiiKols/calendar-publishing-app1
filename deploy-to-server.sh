#!/bin/bash
# ========================================
# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è Calendar App –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ========================================
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-to-server.sh
# ========================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

# ========================================
# –ù–ê–°–¢–†–û–ô–ö–ò (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ–¥ —Å–µ–±—è)
# ========================================
SERVER="user@your-server-ip"              # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
PROJECT_PATH="/home/user/calendar-app"    # –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
BRANCH="main"                             # –í–µ—Ç–∫–∞ –¥–ª—è –¥–µ–ø–ª–æ—è

# ========================================
# –¶–í–ï–¢–ê –î–õ–Ø –í–´–í–û–î–ê
# ========================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ========================================
# –§–£–ù–ö–¶–ò–ò
# ========================================

print_step() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_error() {
    echo -e "${RED}‚úó${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

# ========================================
# –ü–†–û–í–ï–†–ö–ò
# ========================================

print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ SERVER –∏–∑–º–µ–Ω–µ–Ω
if [[ "$SERVER" == "user@your-server-ip" ]]; then
    print_error "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–∑–º–µ–Ω–∏—Ç–µ SERVER –≤ —Å–∫—Ä–∏–ø—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä!"
    echo "  –û—Ç–∫—Ä–æ–π—Ç–µ: nano deploy-to-server.sh"
    echo "  –ò–∑–º–µ–Ω–∏—Ç–µ: SERVER=\"user@your-real-server-ip\""
    exit 1
fi

print_success "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"

# ========================================
# 1. –ü–†–û–í–ï–†–ö–ê –õ–û–ö–ê–õ–¨–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–ô
# ========================================

print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."

if [[ -n $(git status -s) ]]; then
    print_warning "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    git status -s
    echo ""
    read -p "–ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ–π—á–∞—Å? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        read -p "–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: " commit_message
        git add .
        git commit -m "$commit_message"
        print_success "–ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
    else
        print_error "–î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é."
        exit 1
    fi
fi

# ========================================
# 2. PUSH –í GIT
# ========================================

print_step "–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Git..."

git push origin $BRANCH || {
    print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git"
    exit 1
}

print_success "–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Git"

# ========================================
# 3. BACKUP –ë–î –ù–ê –°–ï–†–í–ï–†–ï (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ========================================

echo ""
read -p "–°–æ–∑–¥–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º? (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_step "–°–æ–∑–¥–∞–Ω–∏–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    ssh $SERVER "cd $PROJECT_PATH && docker-compose exec -T postgres pg_dump -U calendar_user calendar_db > backup_\$(date +%Y%m%d_%H%M%S).sql" || {
        print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å backup (–≤–æ–∑–º–æ–∂–Ω–æ –ë–î –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞)"
    }
    
    print_success "Backup —Å–æ–∑–¥–∞–Ω"
fi

# ========================================
# 4. –î–ï–ü–õ–û–ô –ù–ê –°–ï–†–í–ï–†
# ========================================

print_step "–î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

ssh $SERVER << ENDSSH
set -e

echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
cd $PROJECT_PATH

echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
git pull origin $BRANCH

echo "üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down

echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
docker-compose build --no-cache app

echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose up -d

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose ps

echo "üìä –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫)..."
docker-compose logs --tail=20 app

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
ENDSSH

if [ $? -eq 0 ]; then
    print_success "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
else
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ"
    exit 1
fi

# ========================================
# 5. –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò
# ========================================

print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

# –ü–æ–ª—É—á–∏—Ç—å IP —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π SERVER
SERVER_IP=$(echo $SERVER | sed 's/.*@//')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl
if curl -s -o /dev/null -w "%{http_code}" "http://$SERVER_IP:3000" | grep -q "200\|301\|302"; then
    print_success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://$SERVER_IP:3000"
else
    print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç)"
    echo "  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é: http://$SERVER_IP:3000"
fi

# ========================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ========================================

echo ""
echo "========================================="
echo -e "${GREEN}üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!${NC}"
echo "========================================="
echo ""
echo "üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo ""
echo "  –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "    ssh $SERVER \"cd $PROJECT_PATH && docker-compose logs -f\""
echo ""
echo "  –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
echo "    ssh $SERVER \"cd $PROJECT_PATH && docker-compose ps\""
echo ""
echo "  –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
echo "    http://$SERVER_IP:3000"
echo ""
echo "========================================="
