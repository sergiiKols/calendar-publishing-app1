#!/bin/bash
# ========================================
# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –°–ï–†–í–ï–†–ï
# ========================================
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./server-update.sh
# ========================================

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Calendar App${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# ========================================
# 1. BACKUP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ========================================

read -p "–°–æ–∑–¥–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${BLUE}üì¶ –°–æ–∑–¥–∞–Ω–∏–µ backup...${NC}"
    docker-compose exec -T postgres pg_dump -U calendar_user calendar_db > backup_$(date +%Y%m%d_%H%M%S).sql
    echo -e "${GREEN}‚úì Backup —Å–æ–∑–¥–∞–Ω${NC}"
fi

# ========================================
# 2. –ü–û–õ–£–ß–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô
# ========================================

echo ""
echo -e "${BLUE}üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git...${NC}"
git pull origin main

# ========================================
# 3. –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –ó–ê–í–ò–°–ò–ú–û–°–¢–Ø–•
# ========================================

if git diff HEAD@{1} HEAD -- package.json | grep -q "dependencies\|devDependencies"; then
    echo -e "${YELLOW}‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json${NC}"
    BUILD_FLAG="--no-cache"
else
    BUILD_FLAG=""
fi

# ========================================
# 4. –ü–ï–†–ï–ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
# ========================================

echo ""
echo -e "${BLUE}üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
docker-compose down

echo -e "${BLUE}üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...${NC}"
docker-compose build $BUILD_FLAG app

echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
docker-compose up -d

# ========================================
# 5. –ü–†–û–í–ï–†–ö–ê
# ========================================

echo ""
echo -e "${BLUE}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...${NC}"
sleep 5

echo ""
echo -e "${BLUE}‚úÖ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:${NC}"
docker-compose ps

echo ""
echo -e "${BLUE}üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:${NC}"
docker-compose logs --tail=30

# ========================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ========================================

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "  docker-compose logs -f"
echo ""
